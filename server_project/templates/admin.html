<!-- templates/admin.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 페이지</title>
    <style>
        table { width: 95%; margin: 20px auto; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 8px; text-align: center; border: 1px solid #ccc; }
        input[type="number"], input[type="text"] { width: 80px; }
        .btn { padding: 4px 10px; margin: 2px; }
        .green { background: #d2f8d2; }
        .red { background: #ffdcdc; }
        .blue { background: #d2e9ff; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">KREAM 관리자 회원관리</h2>
    <table>
        <thead>
            <tr>
                <th>아이디</th>
                <th>승인여부</th>
                <th>가입일</th>
                <th>만료일</th>
                <th>비밀번호 변경</th>
                <th>기간수정</th>
                <th>조치</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>

    <script>
        fetch("/admin/users")
            .then(res => res.json())
            .then(users => {
                const tbody = document.getElementById("userTable");
                users.forEach(user => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.approved ? "✅ 승인" : "⏳ 대기중"}</td>
                        <td>${user.created_at || "-"}</td>
                        <td>${user.access_expire || "-"}</td>
                        <td>
                            <input type="text" id="pw_${user.username}" placeholder="새 비번">
                            <button class="btn blue" onclick="updatePassword('${user.username}')">변경</button>
                        </td>
                        <td>
                            <input type="number" id="days_${user.username}" placeholder="일수">
                            <button class="btn green" onclick="updatePeriod('${user.username}')">적용</button>
                        </td>
                        <td>
                            <button class="btn green" onclick="approve('${user.username}', 30)">승인</button>
                            <button class="btn red" onclick="reject('${user.username}')">삭제</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });

        function approve(username, days) {
            fetch(`/admin/approve/${username}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ days })
            }).then(() => location.reload());
        }

        function reject(username) {
            if (!confirm(`${username} 회원을 삭제할까요?`)) return;
            fetch(`/admin/reject/${username}`, { method: "POST" }).then(() => location.reload());
        }

        function updatePassword(username) {
            const pw = document.getElementById(`pw_${username}`).value;
            if (!pw) return alert("비밀번호를 입력해주세요.");
            fetch(`/admin/update_password/${username}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: pw })
            }).then(res => res.json()).then(data => {
                alert(data.message);
            });
        }

        function updatePeriod(username) {
            const days = parseInt(document.getElementById(`days_${username}`).value);
            if (!days || days < 1 || days > 365) return alert("1~365일 범위로 입력해주세요.");
            fetch(`/admin/set_period/${username}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ days })
            }).then(res => res.json()).then(data => {
                alert(data.message);
                location.reload();
            });
        }
    </script>
</body>
</html>
